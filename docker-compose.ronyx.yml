version: '3.8'

x-ronyx-defaults: &ronyx-defaults
  restart: unless-stopped
  networks:
    - ronyx-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  ronyx-postgres:
    <<: *ronyx-defaults
    image: postgres:15-alpine
    container_name: ronyx-postgres
    environment:
      POSTGRES_DB: ronyx_production
      POSTGRES_USER: ronyx_user
      POSTGRES_PASSWORD: ${RONYX_DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ronyx-postgres-data:/var/lib/postgresql/data
      - ./init-scripts/ronyx-init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./backups:/backups:ro
    ports:
      - "5432:5432"
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ronyx_user"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  ronyx-redis:
    <<: *ronyx-defaults
    image: redis:7-alpine
    container_name: ronyx-redis
    command: >
      redis-server
      --requirepass ${RONYX_REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
    volumes:
      - ronyx-redis-data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  ronyx-minio:
    <<: *ronyx-defaults
    image: minio/minio:RELEASE.2023-12-09T21-30-04Z
    container_name: ronyx-minio
    environment:
      MINIO_ROOT_USER: ${RONYX_MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${RONYX_MINIO_ROOT_PASSWORD}
      MINIO_DEFAULT_BUCKETS: "ronyx-tickets,ronyx-documents,ronyx-backups"
    command: >
      server /data
      --console-address ":9001"
      --address ":9000"
    volumes:
      - ronyx-minio-data:/data
      - ./minio-config:/root/.minio
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  ronyx-nginx:
    <<: *ronyx-defaults
    image: nginx:alpine
    container_name: ronyx-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.ronyx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - ronyx-postgres
      - ronyx-redis
      - ronyx-minio

  ronyx-ticket-worker:
    <<: *ronyx-defaults
    build:
      context: ./services/ticket-worker
      dockerfile: Dockerfile.ronyx
    container_name: ronyx-ticket-worker
    environment:
      - NODE_ENV=production
      - TENANT_ID=ronyx
      - DATABASE_URL=postgresql://ronyx_user:${RONYX_DB_PASSWORD}@ronyx-postgres:5432/ronyx_production
      - REDIS_URL=redis://:${RONYX_REDIS_PASSWORD}@ronyx-redis:6379/0
      - MINIO_ENDPOINT=http://ronyx-minio:9000
      - MINIO_ACCESS_KEY=${RONYX_MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${RONYX_MINIO_ROOT_PASSWORD}
      - GOOGLE_VISION_API_KEY=${RONYX_GOOGLE_VISION_API_KEY}
    volumes:
      - ./services/ticket-worker:/app
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      ronyx-postgres:
        condition: service_healthy
      ronyx-redis:
        condition: service_healthy
      ronyx-minio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  ronyx-compliance:
    <<: *ronyx-defaults
    build:
      context: ./services/compliance
      dockerfile: Dockerfile.ronyx
    container_name: ronyx-compliance
    environment:
      - TENANT_ID=ronyx
      - STATE=TX
      - DATABASE_URL=postgresql://ronyx_user:${RONYX_DB_PASSWORD}@ronyx-postgres:5432/ronyx_production
      - FMCSA_API_KEY=${RONYX_FMCSA_API_KEY}
    volumes:
      - ./services/compliance:/app
    depends_on:
      - ronyx-postgres

  ronyx-backup:
    <<: *ronyx-defaults
    image: alpine:latest
    container_name: ronyx-backup
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts:/scripts
      - ./backups:/backups
      - ronyx-postgres-data:/source/postgres:ro
      - ronyx-redis-data:/source/redis:ro
      - ronyx-minio-data:/source/minio:ro
    command: >
      sh -c "
      apk add --no-cache bash postgresql-client redis curl rclone &&
      cp /scripts/backup.sh /usr/local/bin/ &&
      cp /scripts/crontab /etc/crontabs/root &&
      chmod +x /usr/local/bin/backup.sh &&
      crond -f -l 2
      "
    environment:
      - RONYX_DB_PASSWORD=${RONYX_DB_PASSWORD}
      - RONYX_REDIS_PASSWORD=${RONYX_REDIS_PASSWORD}
      - RCLONE_CONFIG=/scripts/rclone.conf
    restart: unless-stopped

  ronyx-monitoring:
    <<: *ronyx-defaults
    image: prom/prometheus:latest
    container_name: ronyx-monitoring
    volumes:
      - ./monitoring/prometheus.ronyx.yml:/etc/prometheus/prometheus.yml:ro
      - ronyx-monitoring-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    depends_on:
      - ronyx-postgres
      - ronyx-redis
      - ronyx-minio

volumes:
  ronyx-postgres-data:
    name: ronyx-postgres-data
  ronyx-redis-data:
    name: ronyx-redis-data
  ronyx-minio-data:
    name: ronyx-minio-data
  ronyx-monitoring-data:
    name: ronyx-monitoring-data

networks:
  ronyx-network:
    name: ronyx-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
